# Design: 聊天对话集成Agent工具功能

## Context
当前系统架构中，聊天功能（LLM API）和Agent功能（Agent API）是分离的。用户需要在两个不同的页面之间切换才能使用工具能力。为了提供更好的用户体验，需要将Agent工具能力集成到聊天对话中。

## Goals / Non-Goals

### Goals
- 在聊天API中支持可选的Agent模式，当启用时自动使用Agent引擎处理请求
- 前端聊天界面支持Agent模式开关，用户可以选择是否启用工具调用
- 前端界面清晰展示工具调用过程（工具名称、参数、结果）
- 保持向后兼容，默认不启用Agent模式
- 支持流式输出时显示工具调用状态

### Non-Goals
- 不强制所有聊天都使用Agent模式（保持灵活性）
- 不实现新的工具（使用现有的工具系统）
- 不改变Agent引擎的核心逻辑（仅集成调用）

## Decisions

### Decision: 在聊天API中添加可选Agent模式参数
- **Rationale**: 
  - 保持向后兼容，现有聊天功能不受影响
  - 用户可以选择是否使用工具能力
  - 实现简单，只需在API层面添加条件判断
- **Alternatives considered**: 
  - 创建新的聊天接口：会增加API复杂度，用户需要学习新接口
  - 自动检测是否需要工具：难以准确判断，可能误判

### Decision: 前端使用Toggle开关控制Agent模式
- **Rationale**: 
  - 用户明确知道当前是否启用工具
  - 可以随时切换模式
  - UI清晰直观
- **Alternatives considered**: 
  - 自动模式：用户无法控制，体验不佳
  - 命令触发：需要用户记住特殊命令

### Decision: 工具调用信息显示在消息metadata中
- **Rationale**: 
  - 不破坏现有的消息结构
  - 工具调用是消息的附加信息
  - 便于前端解析和显示
- **Alternatives considered**: 
  - 单独的工具调用消息：会增加消息列表复杂度
  - 工具调用作为独立响应：需要额外的API调用

### Decision: 前端重新设计聊天界面
- **Rationale**: 
  - 当前界面较简单，需要优化以支持工具调用显示
  - 提升整体用户体验
  - 更好的信息层次和视觉反馈
- **Implementation**: 
  - 采用卡片式消息布局
  - 工具调用使用折叠卡片显示
  - 添加加载状态和动画效果

## Risks / Trade-offs

### Risk: Agent模式可能增加响应时间
- **Mitigation**: 
  - 提供清晰的加载状态提示
  - 支持流式输出，用户可以实时看到进度
  - 工具调用过程可视化，用户了解正在执行的操作

### Risk: 工具调用失败可能影响用户体验
- **Mitigation**: 
  - 实现错误处理和降级机制
  - 工具调用失败时，Agent可以继续使用LLM回答
  - 前端显示友好的错误提示

### Risk: 前端状态管理复杂度增加
- **Mitigation**: 
  - 使用Pinia store集中管理状态
  - 工具调用信息作为消息的metadata存储
  - 保持状态结构清晰

## Migration Plan

### Phase 1: 后端API扩展
1. 修改请求/响应模型，添加Agent模式参数
2. 修改聊天路由，支持Agent模式条件判断
3. 集成Agent引擎调用逻辑
4. 添加错误处理和测试

### Phase 2: 前端API和状态管理
1. 更新API客户端类型定义
2. 扩展Pinia store支持Agent模式
3. 修改消息发送逻辑

### Phase 3: 前端UI重新设计
1. 重新设计聊天页面布局
2. 添加Agent模式开关
3. 创建工具调用显示组件
4. 优化交互体验

### Phase 4: 测试和文档
1. 编写单元测试和集成测试
2. 更新API文档和前端设计文档
3. 添加使用示例

## Open Questions
- [ ] 是否需要支持部分消息使用Agent模式（某些消息用工具，某些不用）？
- [ ] 工具调用结果是否需要持久化存储？
- [ ] 是否需要支持工具调用的历史记录查看？
