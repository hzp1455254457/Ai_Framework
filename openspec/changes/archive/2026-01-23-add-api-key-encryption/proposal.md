# Proposal: Add API Key Encryption Storage

## Why

当前 API 密钥以明文形式存储在配置文件中，存在安全风险。在生产环境中，API 密钥应该加密存储，以保护敏感信息不被泄露。

**理由**：
1. **安全必需**：API 密钥是敏感信息，必须加密存储（P1 优先级）
2. **生产环境要求**：生产环境不能使用明文存储密钥
3. **合规要求**：符合安全最佳实践和合规要求
4. **密钥轮换支持**：加密存储为密钥轮换机制提供基础

## What Changes

### 核心变更

1. **加密服务模块** (`infrastructure/config/encryption.py`)
   - 实现密钥加密/解密功能
   - 支持对称加密（AES-256）
   - 支持密钥派生（使用 PBKDF2）
   - 提供加密/解密接口

2. **配置管理器扩展** (`infrastructure/config/manager.py`)
   - 添加加密配置项标记机制
   - 自动加密/解密敏感配置项
   - 支持加密密钥配置
   - 向后兼容明文配置（开发环境）

3. **配置加载器扩展** (`infrastructure/config/loader.py`)
   - 检测加密配置项
   - 自动解密配置值
   - 支持加密配置文件

4. **配置验证器扩展** (`infrastructure/config/validator.py`)
   - 验证加密配置格式
   - 验证加密密钥配置

5. **配置文件更新** (`config/default.yaml`)
   - 添加加密配置项
   - 添加加密密钥配置（可选，支持环境变量）

6. **单元测试** (`tests/unit/infrastructure/config/test_encryption.py`)
   - 加密/解密功能测试
   - 配置管理器集成测试
   - 向后兼容性测试

7. **文档更新**
   - 更新 `infrastructure/config/README.md`
   - 添加加密配置使用说明
   - 添加密钥管理最佳实践

### 技术细节

- **加密算法**：AES-256-GCM（对称加密，带认证）
- **密钥派生**：PBKDF2（使用主密钥派生加密密钥）
- **密钥存储**：主密钥通过环境变量或密钥管理服务提供
- **向后兼容**：开发环境支持明文配置，生产环境强制加密
- **配置标记**：使用特殊前缀（如 `encrypted:`）标记加密配置项

## Impact

### 正面影响

- ✅ **安全性提升**：API 密钥加密存储，降低泄露风险
- ✅ **生产就绪**：满足生产环境安全要求
- ✅ **合规性**：符合安全最佳实践
- ✅ **可扩展性**：为密钥轮换机制提供基础

### 潜在风险

- ⚠️ **密钥管理**：主密钥的安全管理是关键，需要妥善保管
- ⚠️ **性能影响**：加密/解密操作可能影响配置加载性能（影响很小）
- ⚠️ **向后兼容**：需要确保现有配置仍然可用

### 依赖关系

- **依赖**：
  - 配置管理器（已完成）
  - Python 加密库（`cryptography`）

- **被依赖**：
  - 所有使用配置的服务（LLM、Vision、Agent 等）
  - 密钥轮换机制（未来）

## Non-Goals

本次提案**不包含**以下内容：

- ❌ 密钥轮换机制（将在后续提案中实现）
- ❌ 密钥管理服务集成（如 AWS KMS、Azure Key Vault，未来考虑）
- ❌ 非对称加密（当前使用对称加密即可）
- ❌ 配置访问审计（未来考虑）

## Success Criteria

- [ ] 加密服务实现完成，通过所有单元测试
- [ ] 配置管理器支持加密配置项
- [ ] 向后兼容，现有配置仍然可用
- [ ] 文档更新完成，包含使用说明和最佳实践
- [ ] 测试覆盖率 ≥ 80%
- [ ] 性能影响可接受（配置加载时间增加 < 10%）
