# Tasks: Add API Key Encryption Storage

## 任务列表

### 1. 实现加密服务模块
**角色**：`infrastructure-developer`
**文件**：`infrastructure/config/encryption.py`
**描述**：
- 创建 `EncryptionService` 类
- 实现 `encrypt()` 方法（使用 AES-256-GCM）
- 实现 `decrypt()` 方法
- 实现密钥派生（使用 PBKDF2）
- 实现密钥管理（从环境变量或配置文件读取主密钥）
- 错误处理和异常定义

**验收标准**：
- [x] 加密/解密功能正确实现
- [x] 密钥派生算法正确
- [x] 错误处理完善
- [x] 代码包含完整的类型注解和文档字符串

### 2. 扩展配置管理器
**角色**：`infrastructure-developer`
**文件**：`infrastructure/config/manager.py`
**描述**：
- 添加加密服务实例
- 添加敏感配置项标记机制（如 `encrypted:` 前缀）
- 在 `get()` 方法中自动解密加密配置项
- 在 `set()` 方法中支持加密配置项
- 添加 `encrypt_value()` 和 `decrypt_value()` 辅助方法
- 支持环境变量 `ENCRYPTION_KEY` 或配置文件中的主密钥

**验收标准**：
- [x] 加密配置项自动解密
- [x] 向后兼容明文配置
- [x] 主密钥配置正确
- [x] 代码与现有配置管理器集成良好

### 3. 扩展配置加载器
**角色**：`infrastructure-developer`
**文件**：`infrastructure/config/loader.py`
**描述**：
- 检测加密配置项（识别 `encrypted:` 前缀）
- 在加载配置时自动解密
- 支持加密配置文件格式

**验收标准**：
- [x] 加密配置项正确识别和解密
- [x] 不影响现有配置加载流程
- [x] 错误处理完善

### 4. 扩展配置验证器
**角色**：`infrastructure-developer`
**文件**：`infrastructure/config/validator.py`
**描述**：
- 验证加密配置格式
- 验证加密密钥配置
- 验证主密钥是否存在

**验收标准**：
- [x] 验证规则正确
- [x] 错误信息清晰

### 5. 更新配置文件
**角色**：`infrastructure-developer`
**文件**：`config/default.yaml`
**描述**：
- 添加加密配置示例
- 添加加密密钥配置说明（注释）
- 保持现有配置格式不变（向后兼容）

**验收标准**：
- [x] 配置文件格式正确
- [x] 示例清晰易懂
- [x] 向后兼容

### 6. 编写单元测试
**角色**：`ai-framework-qa-engineer`
**文件**：`tests/unit/infrastructure/config/test_encryption.py`
**描述**：
- 测试加密/解密功能
- 测试密钥派生
- 测试配置管理器集成
- 测试向后兼容性
- 测试错误处理

**验收标准**：
- [x] 测试覆盖率 ≥ 80%
- [x] 所有测试用例通过（22个测试全部通过）
- [x] 测试覆盖加密/解密、集成、兼容性等场景

### 7. 更新文档
**角色**：`ai-framework-documenter`
**文件**：`infrastructure/config/README.md`
**描述**：
- 添加加密配置使用说明
- 添加密钥管理最佳实践
- 添加配置示例
- 添加安全注意事项

**验收标准**：
- [x] 文档内容完整
- [x] 示例代码可运行
- [x] 安全注意事项清晰

## 任务依赖关系

```
任务1 (加密服务模块) 
  ↓
任务2 (配置管理器扩展) ← 依赖任务1
任务3 (配置加载器扩展) ← 依赖任务1
任务4 (配置验证器扩展) ← 依赖任务1
  ↓
任务5 (配置文件更新) ← 依赖任务2-4
  ↓
任务6 (单元测试) ← 依赖任务1-5
  ↓
任务7 (文档更新) ← 依赖任务1-6
```

## 预计工作量

- **任务1**：4-6 小时（加密算法实现和测试）
- **任务2**：3-4 小时（配置管理器集成）
- **任务3**：2-3 小时（配置加载器扩展）
- **任务4**：1-2 小时（配置验证器扩展）
- **任务5**：0.5 小时
- **任务6**：3-4 小时
- **任务7**：1-2 小时

**总计**：约 14.5-21.5 小时（2-3 个工作日）
