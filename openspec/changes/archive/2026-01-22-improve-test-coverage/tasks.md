# Tasks: Improve Test Coverage to 80%+

## 1. Proposal (OpenSpec)
- [x] 1.1 明确 capability 划分：`test-coverage`
- [x] 1.2 完成 `proposal.md`（why/what/impact/non-goals）
- [x] 1.3 完成 `design.md`（技术设计和决策）
- [x] 1.4 完成 `tasks.md`（本文件）
- [x] 1.5 完成 spec deltas：
  - [x] 1.5.1 `specs/test-coverage/spec.md`
- [ ] 1.6 运行 `openspec validate improve-test-coverage --strict` 并修复所有问题

## 2. Implementation (after approval)

### 2.1 适配器测试改进（角色：ai-framework-qa-engineer）

#### 2.1.1 DeepSeek适配器测试扩展
- [x] 2.1.1.1 补充流式响应测试
  - [x] 测试流式调用成功场景
  - [x] 测试流式响应解析
  - [x] 测试流式响应中断处理
- [x] 2.1.1.2 补充错误处理测试
  - [x] HTTP错误状态码（400, 401, 403, 429, 500）
  - [x] 网络超时错误
  - [x] 响应格式错误
- [x] 2.1.1.3 补充边界条件测试
  - [x] 空消息列表
  - [x] 无效模型名称
  - [x] 无效参数值

#### 2.1.2 Doubao适配器测试扩展
- [x] 2.1.2.1 补充流式响应测试
- [x] 2.1.2.2 补充错误处理测试
- [x] 2.1.2.3 补充边界条件测试

#### 2.1.3 Qwen适配器测试扩展
- [x] 2.1.3.1 补充流式响应测试
- [x] 2.1.3.2 补充错误处理测试
- [x] 2.1.3.3 补充边界条件测试

#### 2.1.4 OpenAI适配器测试扩展
- [x] 2.1.4.1 检查现有测试覆盖率
- [x] 2.1.4.2 补充流式响应测试
- [x] 2.1.4.3 补充错误处理测试
- [x] 2.1.4.4 补充边界条件测试

#### 2.1.5 Claude适配器测试扩展
- [x] 2.1.5.1 补充流式响应测试（SSE格式）
- [x] 2.1.5.2 补充错误处理测试
- [x] 2.1.5.3 补充边界条件测试

#### 2.1.6 Ollama适配器测试扩展
- [x] 2.1.6.1 补充流式响应测试（JSON Lines格式）
- [x] 2.1.6.2 补充错误处理测试
- [x] 2.1.6.3 补充边界条件测试

### 2.2 配置加载器测试（角色：ai-framework-qa-engineer）

#### 2.2.1 创建测试文件
- [x] 2.2.1.1 创建 `tests/unit/infrastructure/config/test_loader.py`
- [x] 2.2.1.2 设置测试类和基础fixture

#### 2.2.2 环境变量加载测试
- [x] 2.2.2.1 测试`load_environment_variables`方法
- [x] 2.2.2.2 测试环境变量前缀过滤
- [x] 2.2.2.3 测试环境变量类型转换
- [x] 2.2.2.4 测试环境变量缺失处理

#### 2.2.3 配置文件格式测试
- [x] 2.2.3.1 测试YAML格式错误处理
- [x] 2.2.3.2 测试JSON格式错误处理
- [x] 2.2.3.3 测试文件不存在处理
- [x] 2.2.3.4 测试文件权限错误处理

#### 2.2.4 嵌套配置解析测试
- [x] 2.2.4.1 测试深层嵌套配置访问
- [x] 2.2.4.2 测试配置合并逻辑
- [x] 2.2.4.3 测试配置覆盖优先级

### 2.3 测试执行和验证

#### 2.3.1 运行测试并检查覆盖率
- [x] 2.3.1.1 运行所有测试：`pytest tests/ --cov=core --cov=infrastructure --cov-report=term-missing`
- [x] 2.3.1.2 检查总体覆盖率是否达到80%+（已达成：81%）
- [x] 2.3.1.3 检查各模块覆盖率是否达到目标

#### 2.3.2 生成覆盖率报告
- [x] 2.3.2.1 生成HTML覆盖率报告
- [x] 2.3.2.2 分析未覆盖的代码行
- [x] 2.3.2.3 补充遗漏的测试场景

#### 2.3.3 更新测试文档
- [ ] 2.3.3.1 更新 `tests/TEST_RESULTS.md`
- [ ] 2.3.3.2 更新覆盖率统计信息
- [ ] 2.3.3.3 记录测试改进内容

### 2.4 项目计划更新

#### 2.4.1 更新项目计划文档
- [ ] 2.4.1.1 更新 `docs/PROJECT_PLAN.md`：标记"提高测试覆盖率到80%+"为已完成
- [ ] 2.4.1.2 添加完成日期和说明

## 3. Validation

### 3.1 测试验证
- [ ] 3.1.1 所有新增测试通过（部分测试需要修复HTTPError mock方式）
- [x] 3.1.2 总体覆盖率≥80%（已达成：81%）
- [x] 3.1.3 关键模块覆盖率≥80%（大部分模块已达到）

### 3.2 代码质量验证
- [ ] 3.2.1 测试代码符合代码规范
- [ ] 3.2.2 测试命名清晰明确
- [ ] 3.2.3 测试文档完整

### 3.3 文档验证
- [ ] 3.3.1 测试结果文档已更新
- [ ] 3.3.2 项目计划文档已更新
