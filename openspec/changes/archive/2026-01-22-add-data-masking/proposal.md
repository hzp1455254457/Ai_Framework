# Proposal: Add Sensitive Data Masking

## Why

当前日志系统和错误处理可能记录敏感信息（如 API 密钥、用户输入等），存在安全风险。需要实现敏感数据脱敏功能，在日志和错误信息中自动脱敏敏感数据。

**理由**：
1. **安全必需**：防止敏感信息泄露到日志和错误信息中（P1 优先级）
2. **合规要求**：符合数据保护法规要求（如 GDPR）
3. **生产环境要求**：生产环境必须脱敏敏感数据
4. **用户体验**：保护用户隐私和数据安全

## What Changes

### 核心变更

1. **数据脱敏服务模块** (`infrastructure/log/masking.py`)
   - 实现敏感数据检测和脱敏功能
   - 支持多种脱敏模式（部分隐藏、完全隐藏、哈希等）
   - 支持自定义脱敏规则
   - 提供脱敏工具函数

2. **日志管理器扩展** (`infrastructure/log/manager.py`)
   - 集成数据脱敏功能
   - 自动脱敏日志消息中的敏感信息
   - 支持配置脱敏规则
   - 支持启用/禁用脱敏（开发/生产环境）

3. **错误处理中间件扩展** (`api/middleware.py`)
   - 在错误响应中脱敏敏感信息
   - 脱敏 API 密钥、用户输入等
   - 保持错误信息可读性

4. **配置支持** (`config/default.yaml`)
   - 添加数据脱敏配置项
   - 配置脱敏规则
   - 配置启用/禁用脱敏

5. **单元测试** (`tests/unit/infrastructure/log/test_masking.py`)
   - 脱敏功能测试
   - 日志管理器集成测试
   - 错误处理集成测试

6. **文档更新**
   - 更新 `infrastructure/log/README.md`
   - 添加数据脱敏使用说明
   - 添加脱敏规则配置说明

### 技术细节

- **脱敏模式**：
  - 部分隐藏：`sk-1234567890abcdef` → `sk-****...****ef`
  - 完全隐藏：`sk-1234567890abcdef` → `***MASKED***`
  - 哈希脱敏：`sk-1234567890abcdef` → `sha256:...`（用于调试）
- **敏感数据检测**：
  - API 密钥模式（`sk-`, `AI_FRAMEWORK_*_API_KEY` 等）
  - 邮箱模式
  - 手机号模式
  - 自定义正则表达式
- **配置驱动**：通过配置文件定义脱敏规则
- **性能优化**：使用正则表达式预编译，减少性能影响

## Impact

### 正面影响

- ✅ **安全性提升**：防止敏感信息泄露到日志和错误信息
- ✅ **合规性**：符合数据保护法规要求
- ✅ **生产就绪**：满足生产环境安全要求
- ✅ **可配置性**：支持自定义脱敏规则

### 潜在风险

- ⚠️ **调试困难**：脱敏后可能影响问题排查（可通过开发模式禁用）
- ⚠️ **性能影响**：脱敏操作可能影响日志性能（影响很小）
- ⚠️ **规则维护**：需要维护脱敏规则，确保覆盖所有敏感数据

### 依赖关系

- **依赖**：
  - 日志管理器（已完成）
  - 错误处理中间件（已完成）

- **被依赖**：
  - 所有使用日志的模块
  - 所有 API 错误响应

## Non-Goals

本次提案**不包含**以下内容：

- ❌ 数据加密（在 `add-api-key-encryption` 提案中实现）
- ❌ 访问审计（未来考虑）
- ❌ 数据分类（未来考虑）

## Success Criteria

- [ ] 数据脱敏服务实现完成，通过所有单元测试
- [ ] 日志管理器集成脱敏功能
- [ ] 错误处理中间件集成脱敏功能
- [ ] 支持多种脱敏模式和规则
- [ ] 文档更新完成，包含使用说明和配置示例
- [ ] 测试覆盖率 ≥ 80%
- [ ] 性能影响可接受（日志性能影响 < 5%）
