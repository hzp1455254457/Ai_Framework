# Proposal: Add Adapter Health Check

## Why

当前适配器系统缺少健康检查机制，无法检测适配器是否可用，也无法实现自动故障转移。在生产环境中，需要监控适配器状态，确保服务可用性。

**理由**：
1. **提升可靠性**：检测适配器可用性，及时发现故障
2. **自动故障转移**：支持多适配器时自动切换到可用适配器
3. **监控和告警**：为监控系统提供适配器健康状态
4. **用户体验**：减少因适配器故障导致的请求失败

## What Changes

### 核心变更

1. **健康检查服务模块** (`core/base/health_check.py`)
   - 定义健康检查接口
   - 实现基础健康检查功能
   - 支持同步和异步健康检查
   - 提供健康状态枚举

2. **适配器基类扩展** (`core/base/adapter.py`)
   - 添加健康检查接口
   - 实现基础健康检查方法
   - 支持自定义健康检查逻辑

3. **LLM 适配器健康检查实现**
   - `core/llm/adapters/base.py`：添加健康检查抽象方法
   - 各 LLM 适配器实现健康检查（如 `openai_adapter.py`、`claude_adapter.py` 等）
   - 通过轻量级 API 调用检测适配器可用性

4. **Vision 适配器健康检查实现**
   - `core/vision/adapters/base.py`：添加健康检查抽象方法
   - Vision 适配器实现健康检查

5. **服务层健康检查集成**
   - `core/llm/service.py`：集成适配器健康检查
   - `core/vision/service.py`：集成适配器健康检查
   - 支持自动故障转移（选择可用适配器）

6. **健康检查 API** (`api/routes/health.py`)
   - 添加适配器健康状态接口
   - 返回所有适配器的健康状态

7. **配置支持** (`config/default.yaml`)
   - 添加健康检查配置项
   - 配置健康检查间隔
   - 配置故障转移策略

8. **单元测试**
   - `tests/unit/core/base/test_health_check.py`
   - `tests/unit/core/llm/test_adapter_health.py`
   - `tests/unit/core/vision/test_adapter_health.py`

9. **文档更新**
   - 更新适配器相关文档
   - 添加健康检查使用说明

### 技术细节

- **健康检查方式**：
  - LLM 适配器：发送轻量级测试请求（如 Token 计算）
  - Vision 适配器：检查 API 端点可用性
  - 超时控制：健康检查超时时间（如 5 秒）
- **健康状态**：
  - `HEALTHY`：适配器可用
  - `UNHEALTHY`：适配器不可用
  - `UNKNOWN`：健康状态未知
- **故障转移策略**：
  - 自动选择可用适配器
  - 支持优先级配置
  - 支持轮询策略

## Impact

### 正面影响

- ✅ **可靠性提升**：及时发现适配器故障
- ✅ **自动故障转移**：提高服务可用性
- ✅ **监控支持**：为监控系统提供健康状态
- ✅ **用户体验**：减少请求失败

### 潜在风险

- ⚠️ **性能影响**：健康检查可能增加系统负载（可通过配置控制）
- ⚠️ **误判风险**：网络波动可能导致误判（需要重试机制）
- ⚠️ **实现复杂度**：需要为每个适配器实现健康检查逻辑

### 依赖关系

- **依赖**：
  - 适配器基类（已完成）
  - LLM/Vision 服务（已完成）

- **被依赖**：
  - 监控系统（未来）
  - 自动故障转移机制（本次实现）

## Non-Goals

本次提案**不包含**以下内容：

- ❌ 负载均衡（将在后续提案中实现）
- ❌ 健康检查历史记录（未来考虑）
- ❌ 自动恢复机制（未来考虑）

## Success Criteria

- [ ] 健康检查服务实现完成，通过所有单元测试
- [ ] LLM 和 Vision 适配器支持健康检查
- [ ] 服务层集成健康检查，支持自动故障转移
- [ ] 健康检查 API 接口实现
- [ ] 文档更新完成
- [ ] 测试覆盖率 ≥ 80%
- [ ] 性能影响可接受（健康检查开销 < 5%）
