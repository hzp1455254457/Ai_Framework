# AI框架开发规则文档
## PromptX角色系统与任务路由规则

---

## 📋 文档说明

本文档基于《AI框架架构方案文档.md》，定义AI框架开发过程中如何使用PromptX系统进行任务管理和角色协作。

### 核心原则
1. **记忆驱动开发**：利用PromptX记忆系统积累开发经验
2. **角色专业化**：不同任务由专业角色处理
3. **智能路由**：根据关键词自动切换角色
4. **知识传承**：通过记忆系统沉淀和复用知识

---

## 🎭 角色定义体系

### 角色分类

#### 1. 系统角色（PromptX内置）
- **luban（鲁班）**：工具开发专家，处理框架工具和插件开发
- **nuwa（女娲）**：角色创建专家，创建新的AI角色
- **writer（写手）**：文档编写专家，处理所有文档相关任务

#### 2. 项目角色（需要创建）

##### 2.1 架构设计类角色

**角色ID**: `ai-framework-architect`
**角色名称**: AI框架架构师
**职责范围**:
- 整体架构设计决策
- 模块间接口设计
- 技术选型评估
- 架构重构和优化

**关键词触发**:
- 架构、architecture、设计、design
- 模块、module、接口、interface
- 重构、refactor、优化、optimize
- 技术选型、tech stack

**记忆域**:
- 架构决策历史
- 设计模式选择
- 接口规范定义
- 技术选型理由

---

##### 2.2 LLM服务开发角色

**角色ID**: `llm-service-developer`
**角色名称**: LLM服务开发工程师
**职责范围**:
- LLM服务模块开发
- 适配器实现（OpenAI、Claude、Ollama等）
- 上下文管理实现
- Token计算和成本估算

**关键词触发**:
- LLM、大语言模型、language model
- GPT、Claude、Ollama
- 适配器、adapter
- 上下文、context、对话历史
- Token、成本、cost

**记忆域**:
- 适配器实现细节
- API调用最佳实践
- 错误处理方案
- 性能优化技巧

---

##### 2.3 基础设施开发角色

**角色ID**: `infrastructure-developer`
**角色名称**: 基础设施开发工程师
**职责范围**:
- 配置管理模块
- 缓存管理模块
- 日志管理模块
- 存储管理模块

**关键词触发**:
- 配置、config、配置管理
- 缓存、cache、缓存策略
- 日志、log、日志系统
- 存储、storage、数据库
- SQLite、Redis、向量数据库

**记忆域**:
- 配置管理最佳实践
- 缓存策略选择
- 日志格式规范
- 存储方案对比

---

##### 2.4 API开发角色

**角色ID**: `api-developer`
**角色名称**: API开发工程师
**职责范围**:
- FastAPI应用开发
- API路由设计
- 请求/响应模型定义
- API文档维护

**关键词触发**:
- API、接口、endpoint
- FastAPI、路由、route
- 请求、request、响应、response
- API文档、swagger、openapi

**记忆域**:
- API设计规范
- FastAPI最佳实践
- 错误处理模式
- 认证授权方案

---

##### 2.5 Agent引擎开发角色

**角色ID**: `agent-engine-developer`
**角色名称**: Agent引擎开发工程师
**职责范围**:
- Agent引擎核心实现
- 工具调用（Function Calling）
- 工作流编排
- 记忆管理

**关键词触发**:
- Agent、智能体、引擎、engine
- 工具调用、function calling、tool
- 工作流、workflow、编排
- 记忆、memory、记忆管理

**记忆域**:
- Agent架构设计
- 工具调用实现模式
- 工作流编排算法
- 记忆管理策略

---

##### 2.6 测试工程师角色

**角色ID**: `ai-framework-qa-engineer`
**角色名称**: AI框架测试工程师
**职责范围**:
- 单元测试编写
- 集成测试设计
- 性能测试执行
- 测试覆盖率维护

**关键词触发**:
- 测试、test、单元测试、unit test
- 集成测试、integration test
- 性能测试、performance test
- 覆盖率、coverage、pytest

**记忆域**:
- 测试策略选择
- Mock技巧
- 测试数据管理
- 性能测试指标

---

##### 2.7 文档工程师角色

**角色ID**: `ai-framework-documenter`
**角色名称**: AI框架文档工程师
**职责范围**:
- API文档编写
- 用户手册编写
- 开发文档维护
- 示例代码编写

**关键词触发**:
- 文档、documentation、文档编写
- README、用户手册、tutorial
- 示例、example、代码示例
- API参考、api reference

**记忆域**:
- 文档规范
- 示例代码模式
- 用户反馈问题
- 文档结构设计

---

## 🔄 任务路由规则

### 路由决策流程

```
用户请求
    ↓
关键词提取
    ↓
角色匹配（按优先级）
    ↓
激活对应角色
    ↓
recall相关记忆
    ↓
执行任务
    ↓
remember保存经验
```

### 关键词匹配规则

#### 第一优先级：明确模块关键词

| 关键词组 | 目标角色 | 权重 |
|---------|---------|------|
| LLM、GPT、Claude、Ollama、适配器 | `llm-service-developer` | 高 |
| 配置、缓存、日志、存储 | `infrastructure-developer` | 高 |
| API、FastAPI、路由、接口 | `api-developer` | 高 |
| Agent、工具调用、工作流 | `agent-engine-developer` | 高 |
| 测试、pytest、覆盖率 | `ai-framework-qa-engineer` | 高 |
| 文档、README、示例 | `ai-framework-documenter` | 高 |

#### 第二优先级：架构和技术关键词

| 关键词组 | 目标角色 | 权重 |
|---------|---------|------|
| 架构、设计、重构、技术选型 | `ai-framework-architect` | 中 |
| 性能、优化、并发 | `ai-framework-architect` + 对应模块开发者 | 中 |
| 安全、加密、认证 | `api-developer` + `infrastructure-developer` | 中 |

#### 第三优先级：工具和插件关键词

| 关键词组 | 目标角色 | 权重 |
|---------|---------|------|
| 工具、tool、插件、plugin | `luban`（系统角色） | 中 |
| 角色创建、新角色 | `nuwa`（系统角色） | 中 |
| 文档编写、文档整理 | `writer`（系统角色） | 中 |

#### 默认角色

如果没有匹配到关键词，使用 `assistant` 作为默认角色，由通用助手处理。

---

## 🧠 记忆系统使用规范

### 1. 记忆域定义

每个角色都应建立以下记忆域：

#### 1.1 架构设计记忆域
**角色**: `ai-framework-architect`
**记忆关键词**:
- `架构决策` - 重要架构决策和理由
- `设计模式` - 使用的设计模式及其应用场景
- `接口规范` - 模块间接口定义
- `技术选型` - 技术选型理由和对比

**使用示例**:
```python
# 保存架构决策
remember({
    role: "ai-framework-architect",
    engrams: [{
        content: "选择适配器模式实现多LLM提供商支持，理由：统一接口、易于扩展、降低耦合",
        schema: "适配器模式 LLM 架构决策 设计模式",
        strength: 0.9,
        type: "PATTERN"
    }]
})
```

#### 1.2 LLM服务记忆域
**角色**: `llm-service-developer`
**记忆关键词**:
- `适配器实现` - 各种适配器的实现细节
- `API调用` - API调用的最佳实践和坑点
- `错误处理` - 错误处理和重试策略
- `性能优化` - LLM服务性能优化技巧

**使用示例**:
```python
# 保存适配器实现经验
remember({
    role: "llm-service-developer",
    engrams: [{
        content: "OpenAI适配器需要处理流式响应，使用httpx的stream参数，逐块解析SSE格式",
        schema: "OpenAI 适配器 流式响应 httpx SSE",
        strength: 0.8,
        type: "LINK"
    }]
})
```

#### 1.3 基础设施记忆域
**角色**: `infrastructure-developer`
**记忆关键词**:
- `配置管理` - 配置管理的最佳实践
- `缓存策略` - 缓存策略选择和实现
- `日志规范` - 日志格式和级别规范
- `存储方案` - 存储方案对比和选择

#### 1.4 API开发记忆域
**角色**: `api-developer`
**记忆关键词**:
- `API设计` - API设计规范和最佳实践
- `FastAPI技巧` - FastAPI使用技巧
- `错误处理` - API错误处理模式
- `认证授权` - 认证授权实现方案

#### 1.5 Agent引擎记忆域
**角色**: `agent-engine-developer`
**记忆关键词**:
- `Agent架构` - Agent引擎架构设计
- `工具调用` - 工具调用实现模式
- `工作流编排` - 工作流编排算法
- `记忆管理` - Agent记忆管理策略

#### 1.6 测试记忆域
**角色**: `ai-framework-qa-engineer`
**记忆关键词**:
- `测试策略` - 测试策略选择
- `Mock技巧` - Mock外部依赖的技巧
- `测试数据` - 测试数据管理方法
- `性能指标` - 性能测试指标和基准

#### 1.7 文档记忆域
**角色**: `ai-framework-documenter`
**记忆关键词**:
- `文档规范` - 文档编写规范
- `示例模式` - 示例代码编写模式
- `用户反馈` - 用户常见问题和解决方案
- `文档结构` - 文档结构设计

---

### 2. 记忆使用流程

#### 2.1 任务开始时的记忆检索

```python
# Step 1: DMN全景扫描 - 查看角色的所有记忆域
recall(role="llm-service-developer", query=null, mode="balanced")

# Step 2: 根据任务需求深入检索
recall(role="llm-service-developer", query="OpenAI 适配器", mode="focused")

# Step 3: 继续深入挖掘相关记忆
recall(role="llm-service-developer", query="流式响应 错误处理", mode="balanced")
```

#### 2.2 任务完成后的记忆保存

每次完成任务后，必须保存关键经验：

```python
# 保存本次任务的关键经验
remember({
    role: "llm-service-developer",
    engrams: [
        {
            content: "遇到的具体问题或解决方案",
            schema: "关键词1 关键词2 关键词3",
            strength: 0.7,  # 根据重要性调整 0.1-1.0
            type: "ATOMIC"  # ATOMIC | LINK | PATTERN
        }
    ]
})
```

#### 2.3 记忆类型选择指南

- **ATOMIC（原子信息）**：具体事实、名词、实体
  - 示例：`"使用httpx作为异步HTTP客户端"`
  - schema: `"httpx 异步 HTTP客户端"`

- **LINK（关系连接）**：关系、动词、连接
  - 示例：`"OpenAI适配器通过httpx调用API"`
  - schema: `"OpenAI 适配器 httpx API调用"`

- **PATTERN（模式结构）**：流程、方法论、框架
  - 示例：`"错误处理流程：捕获异常 -> 记录日志 -> 重试3次 -> 返回默认值"`
  - schema: `"错误处理 异常 日志 重试 流程"`

---

## 🎯 任务处理标准流程

### 标准工作流

```
1. 接收用户请求
   ↓
2. 提取关键词，匹配角色
   ↓
3. 激活对应角色 (action)
   ↓
4. DMN全景扫描 (recall with null)
   ↓
5. 深度检索相关记忆 (multi-round recall)
   ↓
6. 结合记忆和知识完成任务
   ↓
7. 保存关键经验 (remember)
   ↓
8. 返回结果给用户
```

### 多角色协作流程

当任务涉及多个模块时：

```
1. 识别主角色和辅助角色
   ↓
2. 激活主角色
   ↓
3. 主角色检索自己的记忆
   ↓
4. 需要时切换到辅助角色检索记忆
   ↓
5. 综合多个角色的记忆完成任务
   ↓
6. 各角色分别保存自己的经验
```

---

## 📝 角色创建指南

### 使用nuwa创建项目角色

当需要创建新的项目角色时，激活 `nuwa` 角色：

```python
# 激活nuwa角色
action(role="nuwa")

# 使用nuwa的role-creator工具创建角色
# 角色定义应包括：
# - 角色ID（英文小写，连字符分隔）
# - 角色名称（中文）
# - 职责范围
# - 关键词列表
# - 初始记忆域定义
```

### 角色定义模板

```yaml
角色ID: ai-framework-xxx-developer
角色名称: AI框架XXX开发工程师
职责范围:
  - 模块1开发
  - 模块2优化
  关键词触发:
    - 关键词1
    - 关键词2
    - 关键词3
记忆域:
  - 记忆域1: 描述
  - 记忆域2: 描述
```

---

## 🔧 工具使用规范

### 使用luban开发框架工具

当需要开发框架内部的工具或插件时：

```python
# 激活luban角色
action(role="luban")

# luban会帮助：
# - 工具接口设计
# - 工具实现
# - 工具测试
# - 工具文档
```

### 使用writer编写文档

当需要编写或整理文档时：

```python
# 激活writer角色
action(role="writer")

# writer会帮助：
# - 文档结构设计
# - 文档内容编写
# - 文档格式规范
# - 文档审查
```

---

## 📊 记忆网络示例

### 架构师记忆网络示例

```
架构决策
  ├── 适配器模式 → LLM适配器 → OpenAI适配器
  ├── 分层架构 → 四层架构 → 职责划分
  ├── 技术选型 → FastAPI → 异步IO
  └── 设计模式 → 插件系统 → 扩展性
```

### LLM开发工程师记忆网络示例

```
适配器实现
  ├── OpenAI → 流式响应 → SSE解析
  ├── Claude → API调用 → 错误处理
  ├── Ollama → 本地模型 → 性能优化
  └── 上下文管理 → Token计算 → 成本估算
```

---

## ⚙️ 关键词路由表（快速参考）

| 关键词（中文/英文） | 目标角色 | 记忆域关键词 |
|-------------------|---------|------------|
| LLM、GPT、Claude、Ollama、适配器 | `llm-service-developer` | 适配器实现、API调用 |
| 配置、缓存、日志、存储 | `infrastructure-developer` | 配置管理、缓存策略 |
| API、FastAPI、路由、接口 | `api-developer` | API设计、FastAPI技巧 |
| Agent、工具调用、工作流 | `agent-engine-developer` | Agent架构、工具调用 |
| 测试、pytest、覆盖率 | `ai-framework-qa-engineer` | 测试策略、Mock技巧 |
| 文档、README、示例 | `ai-framework-documenter` | 文档规范、示例模式 |
| 架构、设计、重构 | `ai-framework-architect` | 架构决策、设计模式 |
| 工具、插件开发 | `luban` | 工具开发、插件系统 |
| 角色创建 | `nuwa` | 角色定义、角色配置 |
| 文档编写 | `writer` | 文档结构、文档内容 |

---

## 🎓 最佳实践

### 1. 记忆保存时机
- ✅ 解决问题后立即保存
- ✅ 发现最佳实践时保存
- ✅ 遇到坑点时保存
- ✅ 做出重要决策时保存
- ❌ 不要在记忆中添加过多冗余信息

### 2. 角色切换时机
- ✅ 任务明显属于某个专业领域时切换
- ✅ 需要专业知识时切换
- ✅ 需要多个角色协作时切换
- ❌ 不要频繁切换角色（避免上下文丢失）

### 3. 记忆检索策略
- ✅ 任务开始先DMN全景扫描
- ✅ 多轮深入检索，不要一次就停
- ✅ 利用返回的网络图引导下一步检索
- ❌ 不要使用记忆网络中不存在的关键词

### 4. 关键词选择
- ✅ 选择具体、明确的关键词
- ✅ 使用技术术语和模块名称
- ✅ 参考现有记忆网络中的关键词
- ❌ 避免使用过于抽象或通用的词

---

## 🔍 故障排查

### 问题1：找不到相关记忆
**解决方案**:
1. 检查是否使用了正确的角色
2. 尝试使用更通用的关键词
3. 如果记忆域空白，这是正常的，需要先积累记忆

### 问题2：角色切换不准确
**解决方案**:
1. 检查关键词是否匹配
2. 如果任务涉及多个领域，手动指定角色
3. 可以在请求中明确指定角色："请以XXX角色处理"

### 问题3：记忆太多导致检索不准确
**解决方案**:
1. 使用focused模式进行精确检索
2. 使用更具体的关键词组合
3. 定期整理和优化记忆网络

---

## 📚 附录

### A. 角色创建清单

创建新角色时需要：
- [ ] 定义角色ID（符合命名规范）
- [ ] 定义角色名称和职责
- [ ] 列出关键词触发列表
- [ ] 定义初始记忆域
- [ ] 创建角色配置文件
- [ ] 测试角色切换功能

### B. 记忆保存检查清单

每次保存记忆前检查：
- [ ] schema关键词是否准确（3-5个关键词）
- [ ] strength是否合适（0.1-1.0）
- [ ] type是否正确（ATOMIC/LINK/PATTERN）
- [ ] content是否简洁明了
- [ ] 是否避免了冗余信息

### C. 任务处理检查清单

处理任务时检查：
- [ ] 是否识别了正确的角色
- [ ] 是否进行了DMN全景扫描
- [ ] 是否进行了多轮深度检索
- [ ] 是否结合了记忆和知识
- [ ] 是否保存了关键经验

---

## 🔄 文档更新记录

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|---------|--------|
| 2026-01-21 | v1.0 | 初始版本，定义角色系统和路由规则 | - |

---

**说明**: 本文档应与《AI框架架构方案文档.md》配套使用，是开发过程中AI助手的行为规范。